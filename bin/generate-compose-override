#!/usr/bin/env python3
"""Generate docker-compose.override.yml from GritGuard JSON config.

Usage: generate-compose-override < config.json > docker-compose.override.yml

Reads JSON config from stdin and outputs docker-compose override YAML with:
- Volume mounts for allowWrite paths
- Read-only system mounts for basic functionality
"""

import json
import os
import sys
from pathlib import Path


def main():
    # Read config from stdin
    try:
        config = json.load(sys.stdin)
    except json.JSONDecodeError as e:
        print(f"Error: Invalid JSON input: {e}", file=sys.stderr)
        sys.exit(1)

    # Get filesystem config
    filesystem = config.get("filesystem", {})
    allow_write = filesystem.get("allowWrite", [])
    deny_read = filesystem.get("denyRead", [])

    volumes = []

    # Mount allowWrite paths as read-write volumes
    for path in allow_write:
        # Skip /tmp - it's handled by tmpfs in docker-compose.yml
        if path == "/tmp":
            continue

        # Skip if path is in denyRead
        if path in deny_read:
            continue

        # Check if path exists on host before mounting
        if Path(path).exists():
            volumes.append(f"{path}:{path}:rw")
        elif os.environ.get("GRITGUARD_DEBUG") == "1":
            print(f"Warning: Skipping non-existent path: {path}", file=sys.stderr)

    # Mount essential read-only paths for command execution
    readonly_mounts = [
        "/etc/passwd",
        "/etc/group",
        "/etc/resolv.conf",
    ]

    for path in readonly_mounts:
        if Path(path).exists():
            volumes.append(f"{path}:{path}:ro")

    # Generate YAML output
    print("# Auto-generated by generate-compose-override")
    print("# Do not edit - regenerated on each run")
    print("version: '3.8'")
    print("")
    print("services:")
    print("  sandbox:")
    print("    volumes:")

    if volumes:
        for vol in volumes:
            print(f"      - {vol}")
    else:
        print("      []")


if __name__ == "__main__":
    main()
