# GritGuard Docker Compose Configuration
# Used for proxy mode with squid sidecar for network domain filtering
#
# Usage: gritguard-docker with GRITGUARD_DOCKER_PROXY=1
# This file is invoked automatically by the gritguard-docker wrapper

version: '3.8'

services:
  # Squid proxy for network domain filtering
  proxy:
    image: ubuntu/squid:latest
    volumes:
      - ${GRITGUARD_SQUID_CONFIG}:/etc/squid/squid.conf:ro
    networks:
      - sandbox_net
    healthcheck:
      test: ["CMD", "squidclient", "-h", "localhost", "mgr:info"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s

  # Sandbox container running the actual command
  sandbox:
    image: ${GRITGUARD_DOCKER_IMAGE:-gritguard-sandbox:latest}
    user: "${GRITGUARD_USER_ID:-1000}:${GRITGUARD_GROUP_ID:-1000}"
    working_dir: ${GRITGUARD_TARGET_DIR:-/workspace}
    environment:
      - HTTP_PROXY=http://proxy:3128
      - HTTPS_PROXY=http://proxy:3128
      - http_proxy=http://proxy:3128
      - https_proxy=http://proxy:3128
      - NO_PROXY=localhost,127.0.0.1
    depends_on:
      proxy:
        condition: service_healthy
    networks:
      - sandbox_net
    read_only: true
    tmpfs:
      - /tmp:rw,exec,nosuid,nodev
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # Volumes are added via docker-compose.override.yml generated by gritguard-docker
    command: ${GRITGUARD_CMD:-/bin/bash}

networks:
  sandbox_net:
    driver: bridge
    internal: true  # Prevent direct internet access, only through proxy
